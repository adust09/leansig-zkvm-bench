# Poseidon2-16 Full Permutation Test
# Test vector from Plonky3 koala-bear/src/poseidon2.rs
#
# Input:  [894848333, 1437655012, 1200606629, 1690012884, 71131202, 1749206695,
#          1717947831, 120589055, 19776022, 42382981, 1831865506, 724844064,
#          171220207, 1299207443, 227047920, 1783754913]
#
# Expected: [652590279, 1200629963, 1013089423, 1840372851, 19101828, 561050015,
#            1714865585, 994637181, 498949829, 729884572, 1957973925, 263012103,
#            535029297, 2121808603, 964663675, 1473622080]

# ============================================================================
# KoalaBear Field Operations
# ============================================================================
proc kb_reduce
    dup push.0x7F000001 u32lt
    if.true else push.0x7F000001 u32wrapping_sub end
end

proc kb_add
    u32overflowing_add
    if.true push.0x7F000001 u32wrapping_sub
    else exec.kb_reduce end
end

proc kb_mul
    u32overflowing_mul
    dup eq.0
    if.true drop exec.kb_reduce
    else
        # Round 1
        push.33554430 u32overflowing_mul
        swap movup.2 u32overflowing_add movup.2 add
        dup eq.0 if.true drop exec.kb_reduce
        else
            # Round 2
            push.33554430 u32overflowing_mul
            swap movup.2 u32overflowing_add movup.2 add
            dup eq.0 if.true drop exec.kb_reduce
            else
                # Round 3
                push.33554430 u32overflowing_mul
                swap movup.2 u32overflowing_add movup.2 add
                dup eq.0 if.true drop exec.kb_reduce
                else
                    # Round 4
                    push.33554430 u32overflowing_mul
                    swap movup.2 u32overflowing_add movup.2 add
                    dup eq.0 if.true drop exec.kb_reduce
                    else
                        # Round 5
                        push.33554430 u32overflowing_mul
                        swap movup.2 u32overflowing_add movup.2 add
                        dup eq.0 if.true drop exec.kb_reduce
                        else
                            # Round 6 (final)
                            push.33554430 u32overflowing_mul
                            swap movup.2 u32overflowing_add movup.2 add
                            drop exec.kb_reduce
                        end
                    end
                end
            end
        end
    end
end

proc kb_pow3
    dup dup exec.kb_mul exec.kb_mul
end

# ============================================================================
# Load Test Input into State (mem[16..31])
# ============================================================================
proc load_test_input
    push.894848333 mem_store.16
    push.1437655012 mem_store.17
    push.1200606629 mem_store.18
    push.1690012884 mem_store.19
    push.71131202 mem_store.20
    push.1749206695 mem_store.21
    push.1717947831 mem_store.22
    push.120589055 mem_store.23
    push.19776022 mem_store.24
    push.42382981 mem_store.25
    push.1831865506 mem_store.26
    push.724844064 mem_store.27
    push.171220207 mem_store.28
    push.1299207443 mem_store.29
    push.227047920 mem_store.30
    push.1783754913 mem_store.31
end

# ============================================================================
# Load Round Constants
# ============================================================================
proc load_external_initial_constants
    # Round 0 (mem[256..271])
    push.2128964168 mem_store.256
    push.288780357 mem_store.257
    push.316938561 mem_store.258
    push.2126233899 mem_store.259
    push.426817493 mem_store.260
    push.1714118888 mem_store.261
    push.1045008582 mem_store.262
    push.1738510837 mem_store.263
    push.889721787 mem_store.264
    push.8866516 mem_store.265
    push.681576474 mem_store.266
    push.419059826 mem_store.267
    push.1596305521 mem_store.268
    push.1583176088 mem_store.269
    push.1584387047 mem_store.270
    push.1529751136 mem_store.271

    # Round 1 (mem[272..287])
    push.1863858111 mem_store.272
    push.1072044075 mem_store.273
    push.517831365 mem_store.274
    push.1464274176 mem_store.275
    push.1138001621 mem_store.276
    push.428001039 mem_store.277
    push.245709561 mem_store.278
    push.1641420379 mem_store.279
    push.1365482496 mem_store.280
    push.770454828 mem_store.281
    push.693167409 mem_store.282
    push.757905735 mem_store.283
    push.136670447 mem_store.284
    push.436275702 mem_store.285
    push.525466355 mem_store.286
    push.1559174242 mem_store.287

    # Round 2 (mem[288..303])
    push.1030087950 mem_store.288
    push.869864998 mem_store.289
    push.322787870 mem_store.290
    push.267688717 mem_store.291
    push.948964561 mem_store.292
    push.740478015 mem_store.293
    push.679816114 mem_store.294
    push.113662466 mem_store.295
    push.2066544572 mem_store.296
    push.1744924186 mem_store.297
    push.367094720 mem_store.298
    push.1380455578 mem_store.299
    push.1842483872 mem_store.300
    push.416711434 mem_store.301
    push.1342291586 mem_store.302
    push.1692058446 mem_store.303

    # Round 3 (mem[304..319])
    push.1493348999 mem_store.304
    push.1113949088 mem_store.305
    push.210900530 mem_store.306
    push.1071655077 mem_store.307
    push.610242121 mem_store.308
    push.1136339326 mem_store.309
    push.2020858841 mem_store.310
    push.1019840479 mem_store.311
    push.678147278 mem_store.312
    push.1678413261 mem_store.313
    push.1361743414 mem_store.314
    push.61132629 mem_store.315
    push.1209546658 mem_store.316
    push.64412292 mem_store.317
    push.1936878279 mem_store.318
    push.1980661727 mem_store.319
end

proc load_external_final_constants
    # Round 0 (mem[320..335])
    push.1423960925 mem_store.320
    push.2101391318 mem_store.321
    push.1915532054 mem_store.322
    push.275400051 mem_store.323
    push.1168624859 mem_store.324
    push.1141248885 mem_store.325
    push.356546469 mem_store.326
    push.1165250474 mem_store.327
    push.1320543726 mem_store.328
    push.932505663 mem_store.329
    push.1204226364 mem_store.330
    push.1452576828 mem_store.331
    push.1774936729 mem_store.332
    push.926808140 mem_store.333
    push.1184948056 mem_store.334
    push.1186493834 mem_store.335

    # Round 1 (mem[336..351])
    push.843181003 mem_store.336
    push.185193011 mem_store.337
    push.452207447 mem_store.338
    push.510054082 mem_store.339
    push.1139268644 mem_store.340
    push.630873441 mem_store.341
    push.669538875 mem_store.342
    push.462500858 mem_store.343
    push.876500520 mem_store.344
    push.1214043330 mem_store.345
    push.383937013 mem_store.346
    push.375087302 mem_store.347
    push.636912601 mem_store.348
    push.307200505 mem_store.349
    push.390279673 mem_store.350
    push.1999916485 mem_store.351

    # Round 2 (mem[352..367])
    push.1518476730 mem_store.352
    push.1606686591 mem_store.353
    push.1410677749 mem_store.354
    push.1581191572 mem_store.355
    push.1004269969 mem_store.356
    push.143426723 mem_store.357
    push.1747283099 mem_store.358
    push.1016118214 mem_store.359
    push.1749423722 mem_store.360
    push.66331533 mem_store.361
    push.1177761275 mem_store.362
    push.1581069649 mem_store.363
    push.1851371119 mem_store.364
    push.852520128 mem_store.365
    push.1499632627 mem_store.366
    push.1820847538 mem_store.367

    # Round 3 (mem[368..383])
    push.150757557 mem_store.368
    push.884787840 mem_store.369
    push.619710451 mem_store.370
    push.1651711087 mem_store.371
    push.505263814 mem_store.372
    push.212076987 mem_store.373
    push.1482432120 mem_store.374
    push.1458130652 mem_store.375
    push.382871348 mem_store.376
    push.417404007 mem_store.377
    push.2066495280 mem_store.378
    push.1996518884 mem_store.379
    push.902934924 mem_store.380
    push.582892981 mem_store.381
    push.1337064375 mem_store.382
    push.1199354861 mem_store.383
end

proc load_internal_constants
    # 20 internal round constants (mem[384..403])
    push.2102596038 mem_store.384
    push.1533193853 mem_store.385
    push.1436311464 mem_store.386
    push.2012303432 mem_store.387
    push.839997195 mem_store.388
    push.1225781098 mem_store.389
    push.2011967775 mem_store.390
    push.575084315 mem_store.391
    push.1309329169 mem_store.392
    push.786393545 mem_store.393
    push.995788880 mem_store.394
    push.1702925345 mem_store.395
    push.1444525226 mem_store.396
    push.908073383 mem_store.397
    push.1811535085 mem_store.398
    push.1531002367 mem_store.399
    push.1635653662 mem_store.400
    push.1585100155 mem_store.401
    push.867006515 mem_store.402
    push.879151050 mem_store.403
end

proc load_internal_diagonal
    # Diagonal V for 1 + Diag(V) matrix (mem[416..431])
    # V = [-2, 1, 2, 1/2, 3, 4, -1/2, -3, -4, 1/256, 1/8, 1/2^24, -1/256, -1/8, -1/16, -1/2^24]
    # All values computed as proper modular inverses in KoalaBear field (p = 2130706433)
    push.2130706431 mem_store.416    # V[0] = -2 mod p
    push.1 mem_store.417              # V[1] = 1
    push.2 mem_store.418              # V[2] = 2
    push.1065353217 mem_store.419     # V[3] = 1/2 mod p
    push.3 mem_store.420              # V[4] = 3
    push.4 mem_store.421              # V[5] = 4
    push.1065353216 mem_store.422     # V[6] = -1/2 mod p
    push.2130706430 mem_store.423     # V[7] = -3 mod p
    push.2130706429 mem_store.424     # V[8] = -4 mod p
    push.2122383361 mem_store.425     # V[9] = 1/256 mod p
    push.1864368129 mem_store.426     # V[10] = 1/8 mod p
    push.2130706306 mem_store.427     # V[11] = 1/2^24 mod p
    push.8323072 mem_store.428        # V[12] = -1/256 mod p
    push.266338304 mem_store.429      # V[13] = -1/8 mod p
    push.133169152 mem_store.430      # V[14] = -1/16 mod p
    push.127 mem_store.431            # V[15] = -1/2^24 mod p
end

# ============================================================================
# S-box Layers
# ============================================================================
proc sbox_full
    mem_load.16 exec.kb_pow3 mem_store.16
    mem_load.17 exec.kb_pow3 mem_store.17
    mem_load.18 exec.kb_pow3 mem_store.18
    mem_load.19 exec.kb_pow3 mem_store.19
    mem_load.20 exec.kb_pow3 mem_store.20
    mem_load.21 exec.kb_pow3 mem_store.21
    mem_load.22 exec.kb_pow3 mem_store.22
    mem_load.23 exec.kb_pow3 mem_store.23
    mem_load.24 exec.kb_pow3 mem_store.24
    mem_load.25 exec.kb_pow3 mem_store.25
    mem_load.26 exec.kb_pow3 mem_store.26
    mem_load.27 exec.kb_pow3 mem_store.27
    mem_load.28 exec.kb_pow3 mem_store.28
    mem_load.29 exec.kb_pow3 mem_store.29
    mem_load.30 exec.kb_pow3 mem_store.30
    mem_load.31 exec.kb_pow3 mem_store.31
end

proc sbox_partial
    mem_load.16 exec.kb_pow3 mem_store.16
end

# ============================================================================
# 4x4 MDS Matrix
# ============================================================================
# Matrix: [[2,3,1,1],[1,2,3,1],[1,1,2,3],[3,1,1,2]]
# Stores result in mem[4..7]
proc mat4_chunk
    # Input: chunk base address on stack
    # Load 4 elements
    dup mem_load mem_store.0          # x0
    dup push.1 add mem_load mem_store.1  # x1
    dup push.2 add mem_load mem_store.2  # x2
    push.3 add mem_load mem_store.3      # x3

    # y0 = 2*x0 + 3*x1 + x2 + x3
    mem_load.0 dup exec.kb_add              # 2*x0
    mem_load.1 dup dup exec.kb_add exec.kb_add  # 3*x1
    exec.kb_add
    mem_load.2 exec.kb_add
    mem_load.3 exec.kb_add
    mem_store.4

    # y1 = x0 + 2*x1 + 3*x2 + x3
    mem_load.0
    mem_load.1 dup exec.kb_add exec.kb_add
    mem_load.2 dup dup exec.kb_add exec.kb_add exec.kb_add
    mem_load.3 exec.kb_add
    mem_store.5

    # y2 = x0 + x1 + 2*x2 + 3*x3
    mem_load.0 mem_load.1 exec.kb_add
    mem_load.2 dup exec.kb_add exec.kb_add
    mem_load.3 dup dup exec.kb_add exec.kb_add exec.kb_add
    mem_store.6

    # y3 = 3*x0 + x1 + x2 + 2*x3
    mem_load.0 dup dup exec.kb_add exec.kb_add
    mem_load.1 exec.kb_add
    mem_load.2 exec.kb_add
    mem_load.3 dup exec.kb_add exec.kb_add
    mem_store.7
end

proc mat4_store_back
    # Input: chunk base address on stack
    # Store y0..y3 back
    dup mem_load.4 swap mem_store
    dup push.1 add mem_load.5 swap mem_store
    dup push.2 add mem_load.6 swap mem_store
    push.3 add mem_load.7 swap mem_store
end

# ============================================================================
# External Linear Layer (MDS)
# ============================================================================
proc mds_external
    # Apply mat4 to each chunk
    push.16 exec.mat4_chunk push.16 exec.mat4_store_back
    push.20 exec.mat4_chunk push.20 exec.mat4_store_back
    push.24 exec.mat4_chunk push.24 exec.mat4_store_back
    push.28 exec.mat4_chunk push.28 exec.mat4_store_back

    # Compute sums
    mem_load.16 mem_load.20 exec.kb_add
    mem_load.24 exec.kb_add mem_load.28 exec.kb_add
    mem_store.8

    mem_load.17 mem_load.21 exec.kb_add
    mem_load.25 exec.kb_add mem_load.29 exec.kb_add
    mem_store.9

    mem_load.18 mem_load.22 exec.kb_add
    mem_load.26 exec.kb_add mem_load.30 exec.kb_add
    mem_store.10

    mem_load.19 mem_load.23 exec.kb_add
    mem_load.27 exec.kb_add mem_load.31 exec.kb_add
    mem_store.11

    # Add sums to each element
    mem_load.16 mem_load.8 exec.kb_add mem_store.16
    mem_load.17 mem_load.9 exec.kb_add mem_store.17
    mem_load.18 mem_load.10 exec.kb_add mem_store.18
    mem_load.19 mem_load.11 exec.kb_add mem_store.19
    mem_load.20 mem_load.8 exec.kb_add mem_store.20
    mem_load.21 mem_load.9 exec.kb_add mem_store.21
    mem_load.22 mem_load.10 exec.kb_add mem_store.22
    mem_load.23 mem_load.11 exec.kb_add mem_store.23
    mem_load.24 mem_load.8 exec.kb_add mem_store.24
    mem_load.25 mem_load.9 exec.kb_add mem_store.25
    mem_load.26 mem_load.10 exec.kb_add mem_store.26
    mem_load.27 mem_load.11 exec.kb_add mem_store.27
    mem_load.28 mem_load.8 exec.kb_add mem_store.28
    mem_load.29 mem_load.9 exec.kb_add mem_store.29
    mem_load.30 mem_load.10 exec.kb_add mem_store.30
    mem_load.31 mem_load.11 exec.kb_add mem_store.31
end

# ============================================================================
# Internal Linear Layer (1 + Diag(V))
# ============================================================================
proc mds_internal
    # Compute sum of all elements
    mem_load.16 mem_load.17 exec.kb_add
    mem_load.18 exec.kb_add mem_load.19 exec.kb_add
    mem_load.20 exec.kb_add mem_load.21 exec.kb_add
    mem_load.22 exec.kb_add mem_load.23 exec.kb_add
    mem_load.24 exec.kb_add mem_load.25 exec.kb_add
    mem_load.26 exec.kb_add mem_load.27 exec.kb_add
    mem_load.28 exec.kb_add mem_load.29 exec.kb_add
    mem_load.30 exec.kb_add mem_load.31 exec.kb_add
    mem_store.12

    # state[i] = state[i] * diag[i] + sum
    mem_load.16 mem_load.416 exec.kb_mul mem_load.12 exec.kb_add mem_store.16
    mem_load.17 mem_load.417 exec.kb_mul mem_load.12 exec.kb_add mem_store.17
    mem_load.18 mem_load.418 exec.kb_mul mem_load.12 exec.kb_add mem_store.18
    mem_load.19 mem_load.419 exec.kb_mul mem_load.12 exec.kb_add mem_store.19
    mem_load.20 mem_load.420 exec.kb_mul mem_load.12 exec.kb_add mem_store.20
    mem_load.21 mem_load.421 exec.kb_mul mem_load.12 exec.kb_add mem_store.21
    mem_load.22 mem_load.422 exec.kb_mul mem_load.12 exec.kb_add mem_store.22
    mem_load.23 mem_load.423 exec.kb_mul mem_load.12 exec.kb_add mem_store.23
    mem_load.24 mem_load.424 exec.kb_mul mem_load.12 exec.kb_add mem_store.24
    mem_load.25 mem_load.425 exec.kb_mul mem_load.12 exec.kb_add mem_store.25
    mem_load.26 mem_load.426 exec.kb_mul mem_load.12 exec.kb_add mem_store.26
    mem_load.27 mem_load.427 exec.kb_mul mem_load.12 exec.kb_add mem_store.27
    mem_load.28 mem_load.428 exec.kb_mul mem_load.12 exec.kb_add mem_store.28
    mem_load.29 mem_load.429 exec.kb_mul mem_load.12 exec.kb_add mem_store.29
    mem_load.30 mem_load.430 exec.kb_mul mem_load.12 exec.kb_add mem_store.30
    mem_load.31 mem_load.431 exec.kb_mul mem_load.12 exec.kb_add mem_store.31
end

# ============================================================================
# Add Round Constants
# ============================================================================
proc add_rc_16
    # Add 16 round constants starting at address on stack
    dup mem_load mem_load.16 exec.kb_add mem_store.16
    dup push.1 add mem_load mem_load.17 exec.kb_add mem_store.17
    dup push.2 add mem_load mem_load.18 exec.kb_add mem_store.18
    dup push.3 add mem_load mem_load.19 exec.kb_add mem_store.19
    dup push.4 add mem_load mem_load.20 exec.kb_add mem_store.20
    dup push.5 add mem_load mem_load.21 exec.kb_add mem_store.21
    dup push.6 add mem_load mem_load.22 exec.kb_add mem_store.22
    dup push.7 add mem_load mem_load.23 exec.kb_add mem_store.23
    dup push.8 add mem_load mem_load.24 exec.kb_add mem_store.24
    dup push.9 add mem_load mem_load.25 exec.kb_add mem_store.25
    dup push.10 add mem_load mem_load.26 exec.kb_add mem_store.26
    dup push.11 add mem_load mem_load.27 exec.kb_add mem_store.27
    dup push.12 add mem_load mem_load.28 exec.kb_add mem_store.28
    dup push.13 add mem_load mem_load.29 exec.kb_add mem_store.29
    dup push.14 add mem_load mem_load.30 exec.kb_add mem_store.30
    push.15 add mem_load mem_load.31 exec.kb_add mem_store.31
end

proc add_rc_internal
    # Add single RC at address to state[0]
    mem_load mem_load.16 exec.kb_add mem_store.16
end

# ============================================================================
# Full Round (External)
# ============================================================================
proc full_round
    # Stack: [rc_base_addr]
    exec.add_rc_16
    exec.sbox_full
    exec.mds_external
end

# ============================================================================
# Partial Round (Internal)
# ============================================================================
proc partial_round
    # Stack: [rc_addr]
    exec.add_rc_internal
    exec.sbox_partial
    exec.mds_internal
end

# ============================================================================
# Main: Run Poseidon2-16 and output first 4 elements
# ============================================================================
begin
    # Load all constants
    exec.load_external_initial_constants
    exec.load_external_final_constants
    exec.load_internal_constants
    exec.load_internal_diagonal

    # Load test input
    exec.load_test_input

    # Run 4 initial full rounds
    push.256 exec.full_round
    push.272 exec.full_round
    push.288 exec.full_round
    push.304 exec.full_round

    # Run 20 partial rounds
    push.384 exec.partial_round
    push.385 exec.partial_round
    push.386 exec.partial_round
    push.387 exec.partial_round
    push.388 exec.partial_round
    push.389 exec.partial_round
    push.390 exec.partial_round
    push.391 exec.partial_round
    push.392 exec.partial_round
    push.393 exec.partial_round
    push.394 exec.partial_round
    push.395 exec.partial_round
    push.396 exec.partial_round
    push.397 exec.partial_round
    push.398 exec.partial_round
    push.399 exec.partial_round
    push.400 exec.partial_round
    push.401 exec.partial_round
    push.402 exec.partial_round
    push.403 exec.partial_round

    # Run 4 final full rounds
    push.320 exec.full_round
    push.336 exec.full_round
    push.352 exec.full_round
    push.368 exec.full_round

    # Output first 4 results for verification
    # Expected: [652590279, 1200629963, 1013089423, 1840372851, ...]
    mem_load.16
    mem_load.17
    mem_load.18
    mem_load.19

    # Stack now has 4 results + 16 initial = 20 elements
    # Drop 4 to get to 16
    swapdw drop drop drop drop
end
