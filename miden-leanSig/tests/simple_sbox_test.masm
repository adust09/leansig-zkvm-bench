# Simple S-box test - minimal

proc kb_reduce
    dup push.0x7F000001 u32lt
    if.true else push.0x7F000001 u32wrapping_sub end
end

proc kb_add
    u32overflowing_add
    if.true push.0x7F000001 u32wrapping_sub
    else exec.kb_reduce end
end

proc kb_mul
    u32overflowing_mul
    dup eq.0
    if.true drop exec.kb_reduce
    else
        # Round 1
        push.33554430 u32overflowing_mul
        swap movup.2 u32overflowing_add movup.2 add
        dup eq.0 if.true drop exec.kb_reduce
        else
            # Round 2
            push.33554430 u32overflowing_mul
            swap movup.2 u32overflowing_add movup.2 add
            dup eq.0 if.true drop exec.kb_reduce
            else
                # Round 3
                push.33554430 u32overflowing_mul
                swap movup.2 u32overflowing_add movup.2 add
                dup eq.0 if.true drop exec.kb_reduce
                else
                    # Round 4
                    push.33554430 u32overflowing_mul
                    swap movup.2 u32overflowing_add movup.2 add
                    dup eq.0 if.true drop exec.kb_reduce
                    else
                        # Round 5
                        push.33554430 u32overflowing_mul
                        swap movup.2 u32overflowing_add movup.2 add
                        dup eq.0 if.true drop exec.kb_reduce
                        else
                            # Round 6 (final)
                            push.33554430 u32overflowing_mul
                            swap movup.2 u32overflowing_add movup.2 add
                            drop exec.kb_reduce
                        end
                    end
                end
            end
        end
    end
end

proc kb_pow3
    dup dup exec.kb_mul exec.kb_mul
end

begin
    # Store input in memory, compute, load result
    # input[0] = 894848333, rc[0] = 2128964168
    # Expected sum = 893106068
    # Expected cube = 721078406

    push.894848333 mem_store.100
    push.2128964168 mem_store.101

    mem_load.100 mem_load.101 exec.kb_add
    mem_store.102

    mem_load.102 exec.kb_pow3
    mem_store.103

    # Output: [cube, sum, ...]
    mem_load.103
    mem_load.102
    # Stack: [sum, cube, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] = 18 elements

    # Drop 2 to get 16
    swapdw drop drop
    # Stack: [0, 0, 0, 0, 0, 0, sum, cube, 0, 0, 0, 0, 0, 0, 0, 0] = 16 elements
end
