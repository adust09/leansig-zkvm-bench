# KoalaBear x^3 (S-box) Tests
# p = 0x7F000001 = 2130706433
#
# Test cases:
# 1. 2^3 = 8
# 2. 10^3 = 1000
# 3. 100^3 = 1000000
# 4. 10000^3 mod p = 698682923
#
# Expected output: [698682923, 1000000, 1000, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

proc kb_reduce
    dup
    push.0x7F000001
    u32lt
    if.true
    else
        push.0x7F000001
        u32wrapping_sub
    end
end

proc kb_add
    u32overflowing_add
    if.true
        push.0x7F000001
        u32wrapping_sub
    else
        exec.kb_reduce
    end
end

proc kb_mul
    u32overflowing_mul

    dup eq.0
    if.true
        drop
        exec.kb_reduce
    else
        swap
        swap
        push.33554430
        u32overflowing_mul

        swap
        movup.2
        u32overflowing_add

        movup.2
        add

        dup eq.0
        if.true
            drop
            exec.kb_reduce
        else
            swap
            swap
            push.33554430
            u32overflowing_mul
            swap
            movup.2
            u32overflowing_add
            movup.2
            add

            dup eq.0
            if.true
                drop
                exec.kb_reduce
            else
                swap
                swap
                push.33554430
                u32overflowing_mul
                swap
                movup.2
                u32overflowing_add
                movup.2
                add

                dup eq.0
                if.true
                    drop
                    exec.kb_reduce
                else
                    drop
                    exec.kb_reduce
                end
            end
        end
    end
end

# kb_pow3: Compute x^3 mod p (for Poseidon2 S-box)
# Input:  [x, ...]
# Output: [x^3 mod p, ...]
proc kb_pow3
    dup                         # [x, x, ...]
    dup                         # [x, x, x, ...]
    exec.kb_mul                 # [x^2, x, ...]
    exec.kb_mul                 # [x^3, ...]
end

begin
    # Test 1: 2^3 = 8
    push.2 exec.kb_pow3
    # Stack: [8, 0, 0, ...] (17 elements)

    # Test 2: 10^3 = 1000
    push.10 exec.kb_pow3
    # Stack: [1000, 8, 0, ...] (18 elements)

    # Test 3: 100^3 = 1000000
    push.100 exec.kb_pow3
    # Stack: [1000000, 1000, 8, 0, ...] (19 elements)

    # Test 4: 10000^3 mod p = 698682923
    push.10000 exec.kb_pow3
    # Stack: [698682923, 1000000, 1000, 8, 0, ...] (20 elements)

    # Clean up: swap deep zeros to top and drop
    swapdw                      # Positions 0-3 <-> 4-7
    drop drop drop drop         # Drop 4 zeros, now 16 elements
    # Expected: [698682923, 1000000, 1000, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
end
