# Test: RC add + S-box only (no MDS)

proc kb_reduce
    dup push.0x7F000001 u32lt
    if.true else push.0x7F000001 u32wrapping_sub end
end

proc kb_add
    u32overflowing_add
    if.true push.0x7F000001 u32wrapping_sub
    else exec.kb_reduce end
end

proc kb_mul
    u32overflowing_mul
    dup eq.0
    if.true drop exec.kb_reduce
    else
        swap swap push.33554430 u32overflowing_mul
        swap movup.2 u32overflowing_add movup.2 add
        dup eq.0 if.true drop exec.kb_reduce
        else
            swap swap push.33554430 u32overflowing_mul
            swap movup.2 u32overflowing_add movup.2 add
            dup eq.0 if.true drop exec.kb_reduce
            else drop exec.kb_reduce end
        end
    end
end

proc kb_pow3
    dup dup exec.kb_mul exec.kb_mul
end

begin
    # Test single element: input[0] + rc[0] then cubed
    # input[0] = 894848333
    # rc[0] = 2128964168
    # sum = 893106068 (expected)
    # cubed = 721078406 (expected)

    # Initial stack has 16 zeros
    # We'll replace first zero with our result
    drop  # Remove one zero so we have room

    push.894848333
    push.2128964168
    exec.kb_add
    # Stack: [893106068, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]

    exec.kb_pow3
    # Stack: [721078406, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
end
